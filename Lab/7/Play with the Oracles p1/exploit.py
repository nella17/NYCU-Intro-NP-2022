from ctypes import CDLL
from pwn import *
import re

HOST, PORT = 'inp111.zoolab.org', 10007

libc = CDLL("libc.so.6")

if args.REMOTE:
    io = remote(HOST, PORT)
else:
    io = process('./oraclep1.exe')

time = libc.time(0)
info(f'time: {time}')
# pause()

usermsg = b'meow'
userkey = 0x776f6567
magic = 0xdeadbeef

def create(idx):
    idx = str(idx).encode()
    io.sendlineafter(b'>', idx)
    io.sendlineafter(b':', usermsg)

def show(idx):
    idx = str(idx).encode()

    io.sendlineafter(b'>', idx)
    io.sendlineafter(b'?', usermsg)

    io.sendlineafter(b'>', idx)
    io.sendlineafter(b'?', usermsg)

    io.sendlineafter(b'>', idx)

    io.readuntil(b'Unfortunately, you did not make it.\n')
    line = io.readline().decode()
    secret, seed = re.findall('The secret is ``(.+)`` \(from seed (.+)\)', line)[0]
    seed = int(seed, 16)

    info(line)
    return secret, seed

io.sendline(b'meow')

# gen_secret x 4

create(1)
_, seed = show(1)

libc.srand(seed)
for _ in range(4):
    libc.rand()
rand = libc.rand()

create(1)
_, seed = show(1)

# srand(time ^ pid)
# magic = rand()
# pid = seed ^ rand ^ userkey ^ magic

# print(hex(time), hex(seed), hex(rand), hex(userkey))
pid = 1
while True:
    libc.srand(time ^ pid)
    magic = libc.rand()
    x = seed ^ rand ^ userkey ^ magic
    # if not args.REMOTE and pid == io.pid: print(seed, rand, userkey, magic)
    if x == pid:
        info(f'pid: {pid}')
        break
    pid += 1

libc.srand(seed)
for _ in range(4):
    libc.rand()
rand = libc.rand()

seed = rand ^ pid ^ userkey ^ magic
create(1)

payload = ''
libc.srand(seed)
for _ in range(4):
    payload += hex(libc.rand())[2:]
info(f'payload: {payload}')

io.sendlineafter(b'>', b'1')
io.sendlineafter(b'?', payload.encode())

success(io.readuntil(b'}').decode().strip())

# io.interactive()
io.close()

